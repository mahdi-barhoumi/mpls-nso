! Provider reachability using OSPF

! PE1 configuration
enable
configure terminal
hostname PE1
interface Loopback0
no shutdown
ip address 1.1.1.1 255.255.255.255
exit
interface GigabitEthernet0/1
no shutdown
ip address 10.0.12.1 255.255.255.0
exit
router ospf 1
router-id 1.1.1.1
network 1.1.1.1 0.0.0.0 area 0
network 10.0.12.0 0.0.0.255 area 0
exit
end

! P1 configuration
enable
configure terminal
hostname P1
interface Loopback0
no shutdown
ip address 2.2.2.2 255.255.255.255
exit
interface GigabitEthernet0/1
no shutdown
ip address 10.0.12.2 255.255.255.0
exit
interface GigabitEthernet0/2
no shutdown
ip address 10.0.23.2 255.255.255.0
exit
router ospf 1
router-id 2.2.2.2
network 2.2.2.2 0.0.0.0 area 0
network 10.0.12.0 0.0.0.255 area 0
network 10.0.23.0 0.0.0.255 area 0
exit
end

! P2 configuration
enable
configure terminal
hostname P2
interface Loopback0
no shutdown
ip address 3.3.3.3 255.255.255.255
exit
interface GigabitEthernet0/1
no shutdown
ip address 10.0.23.3 255.255.255.0
exit
interface GigabitEthernet0/2
no shutdown
ip address 10.0.34.3 255.255.255.0
exit
router ospf 1
router-id 3.3.3.3
network 3.3.3.3 0.0.0.0 area 0
network 10.0.23.0 0.0.0.255 area 0
network 10.0.34.0 0.0.0.255 area 0
exit
end

! PE2 configuration
enable
configure terminal
hostname PE2
interface Loopback0
no shutdown
ip address 4.4.4.4 255.255.255.255
exit
interface GigabitEthernet0/1
no shutdown
ip address 10.0.34.4 255.255.255.0
exit
router ospf 1
router-id 4.4.4.4
network 4.4.4.4 0.0.0.0 area 0
network 10.0.34.0 0.0.0.255 area 0
exit
end

! MPLS configuration

! PE1 configuration
enable
configure terminal
mpls label range 100 199
mpls ip
interface GigabitEthernet0/1
mpls ip
exit
end

! P1 configuration
enable
configure terminal
mpls label range 200 299
mpls ip
interface GigabitEthernet0/1
mpls ip
exit
interface GigabitEthernet0/2
mpls ip
exit
end

! P2 configuration
enable
configure terminal
mpls label range 300 399
mpls ip
interface GigabitEthernet0/1
mpls ip
exit
interface GigabitEthernet0/2
mpls ip
exit
end

! PE2 configuration
enable
configure terminal
mpls label range 400 499
mpls ip
interface GigabitEthernet0/1
mpls ip
exit
end

! VRF configuration

! PE1 configuration
enable
configure terminal
vrf definition customer-1
rd 1:1
address-family ipv4
route-target export 33:33
route-target import 11:11
exit
vrf definition customer-2
rd 2:2
address-family ipv4
route-target export 44:44
route-target import 22:22
exit
interface GigabitEthernet0/2
description interface connected to customer 1 site 1
no shutdown
vrf forwarding customer-1
ip address 192.168.1.1 255.255.255.0
exit
interface GigabitEthernet0/3
description interface connected to customer 2 site 1
no shutdown
vrf forwarding customer-2
ip address 192.168.2.1 255.255.255.0
exit
end

! PE2 configuration
enable
configure terminal
vrf definition customer-1
rd 1:1
address-family ipv4
route-target export 11:11
route-target import 33:33
exit
vrf definition customer-2
rd 2:2
address-family ipv4
route-target export 22:22
route-target import 44:44
exit
interface GigabitEthernet0/2
description interface connected to customer 1 site 2
no shutdown
vrf forwarding customer-1
ip address 192.168.3.1 255.255.255.0
exit
interface GigabitEthernet0/3
description interface connected to customer 2 site 2
no shutdown
vrf forwarding customer-2
ip address 192.168.4.1 255.255.255.0
exit
end

! Customer-Provider routing

! PE1 configuration
enable
configure terminal
router eigrp 1
address-family ipv4 vrf customer-1
network 0.0.0.0
autonomous-system 1
redistribute bgp 1 metric 1 1 1 1 1
exit
exit
router rip
address-family ipv4 vrf customer-2
version 2
network 0.0.0.0
no auto-summary
redistribute bgp 1 metric 5
exit
exit
end

! C1-S1 configuration
enable
configure terminal
hostname C1-S1
interface Loopback0
no shutdown
ip address 11.11.11.11 255.255.255.255
exit
interface GigabitEthernet0/1
no shutdown
ip address 192.168.1.2 255.255.255.0
exit
router eigrp 1
network 0.0.0.0
exit
end

! C2-S1 configuration
enable
configure terminal
hostname C2-S1
interface Loopback0
no shutdown
ip address 22.22.22.22 255.255.255.255
exit
interface GigabitEthernet0/1
no shutdown
ip address 192.168.2.2 255.255.255.0
exit
router rip
version 2
no auto-summary
network 0.0.0.0
exit
end

! PE2 configuration
enable
configure terminal
router ospf 2 vrf customer-1
router-id 1.1.1.1
network 0.0.0.0 255.255.255.255 area 0
redistribute bgp 1 subnets
exit
router isis
vrf customer-2
net 49.0001.0000.0000.0001.00
is-type level-1-2
redistribute bgp 1
exit
interface GigabitEthernet0/3
ip router isis
exit
end

! C1-S2 configuration
enable
configure terminal
hostname C1-S2
interface Loopback0
no shutdown
ip address 33.33.33.33 255.255.255.255
exit
interface GigabitEthernet0/1
no shutdown
ip address 192.168.3.2 255.255.255.0
exit
router ospf 1
router-id 2.2.2.2
network 0.0.0.0 255.255.255.255 area 0
exit
end

! C2-S2 configuration
enable
configure terminal
hostname C2-S2
router isis
net 49.0001.0000.0000.0002.00
exit
interface Loopback0
no shutdown
ip address 44.44.44.44 255.255.255.255
ip router isis
exit
interface GigabitEthernet0/1
no shutdown
ip address 192.168.4.2 255.255.255.0
ip router isis
exit
end

! Provider iBGP configuration

! PE1 configuration
enable
configure terminal
router bgp 1
neighbor 4.4.4.4 remote-as 1
neighbor 4.4.4.4 update-source loop 0
neighbor 4.4.4.4 next-hop-self
address-family vpnv4
neighbor 4.4.4.4 activate
neighbor 4.4.4.4 send-community extended
exit
address-family ipv4 vrf customer-1
redistribute eigrp 1
exit
address-family ipv4 vrf customer-2
redistribute rip
exit
end

! PE2 configuration
enable
configure terminal
router bgp 1
neighbor 1.1.1.1 remote-as 1
neighbor 1.1.1.1 update-source loop 0
neighbor 1.1.1.1 next-hop-self
address-family vpnv4
neighbor 1.1.1.1 activate
neighbor 1.1.1.1 send-community extended
exit
address-family ipv4 vrf customer-1
redistribute ospf 2
exit
address-family ipv4 vrf customer-2
redistribute isis ip level-1-2
redistribute connected
exit
end

! Provider startup configuration

enable
configure terminal
username mgmt privilege 15 secret mgmtapp
crypto key generate rsa usage-keys label sshkeys modulus 2048
ip ssh rsa keypair-name sshkeys
ip ssh version 2
line vty 0 4
exec-timeout 0
transport input ssh
login local
exit
restconf
lldp run
exit
end
